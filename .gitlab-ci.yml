# ─────────────────────────────────────────────────────────
# GitLab CI/CD Pipeline — Hill Climb Racing Game
# ─────────────────────────────────────────────────────────
# Required CI/CD Variables (GitLab → Settings → CI/CD → Variables):
#   SSH_PRIVATE_KEY   - SSH private key for deployment server
#   DEPLOY_USER       - SSH username (e.g. deploy, root)
#   STAGING_HOST      - Staging server IP/hostname
#   PRODUCTION_HOST   - Production server IP/hostname
#   DB_HOST           - Database host
#   DB_PORT           - Database port
#   DB_NAME           - Database name
#   DB_USER           - Database username
#   DB_PASSWORD       - Database password (masked)
# ─────────────────────────────────────────────────────────

stages:
  - build
  - deploy-staging
  - deploy-production

variables:
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
  DOCKER_IMAGE_LATEST: $CI_REGISTRY_IMAGE:latest

# ─── Build Docker Image ──────────────────────────────────
build:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $DOCKER_IMAGE -t $DOCKER_IMAGE_LATEST .
    - docker push $DOCKER_IMAGE
    - docker push $DOCKER_IMAGE_LATEST
  only:
    - main
    - develop

# ─── Deploy to Staging ────────────────────────────────────
deploy-staging:
  stage: deploy-staging
  image: alpine:latest
  when: manual
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $STAGING_HOST >> ~/.ssh/known_hosts 2>/dev/null
  script:
    - |
      ssh $DEPLOY_USER@$STAGING_HOST << 'ENDSSH'
        # Login to GitLab Container Registry
        docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

        # Pull latest image
        docker pull $DOCKER_IMAGE_LATEST

        # Stop and remove existing container
        docker stop game-test-staging || true
        docker rm game-test-staging || true

        # Run new container
        docker run -d \
          --name game-test-staging \
          --restart unless-stopped \
          -p 3000:3000 \
          -e PORT=3000 \
          -e DB_HOST=$DB_HOST \
          -e DB_PORT=$DB_PORT \
          -e DB_NAME=$DB_NAME \
          -e DB_USER=$DB_USER \
          -e DB_PASSWORD=$DB_PASSWORD \
          $DOCKER_IMAGE_LATEST
      ENDSSH
  environment:
    name: staging
    url: http://$STAGING_HOST:3000
  only:
    - develop

# ─── Deploy to Production ─────────────────────────────────
deploy-production:
  stage: deploy-production
  image: alpine:latest
  when: manual
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $PRODUCTION_HOST >> ~/.ssh/known_hosts 2>/dev/null
  script:
    - |
      ssh $DEPLOY_USER@$PRODUCTION_HOST << 'ENDSSH'
        # Login to GitLab Container Registry
        docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

        # Pull latest image
        docker pull $DOCKER_IMAGE_LATEST

        # Stop and remove existing container
        docker stop game-test-production || true
        docker rm game-test-production || true

        # Run new container
        docker run -d \
          --name game-test-production \
          --restart unless-stopped \
          -p 3000:3000 \
          -e PORT=3000 \
          -e DB_HOST=$DB_HOST \
          -e DB_PORT=$DB_PORT \
          -e DB_NAME=$DB_NAME \
          -e DB_USER=$DB_USER \
          -e DB_PASSWORD=$DB_PASSWORD \
          $DOCKER_IMAGE_LATEST
      ENDSSH
  environment:
    name: production
    url: http://$PRODUCTION_HOST:3000
  only:
    - main
